<!DOCTYPE html>
<html>
<head>
<title>jQuery源码解析3(Event)</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style type="text/css">
</style>
</head>
<body>

<h2>jQuery源码解析3(Event)</h2>
<p>转自: <A href="http://bencode.javaeye.com/blog/577745" target=_blank>http://bencode.javaeye.com/blog/577745</A>
</p>

<DIV class=blog_title>
<DIV class=blog_content>
<P>这一篇，我们要看 jQuery Events 部分的源码。</P>
<P>&nbsp;</P>
<P>这一次看的是1.4的源码，因为API接口没变，但功能增强，并且live支持了所有事件, 支持context等。</P>
<P>&nbsp;</P>
<P>我们平常这样写：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>$(</SPAN><SPAN class=string>'#button'</SPAN><SPAN>).click(</SPAN><SPAN
		class=keyword>function</SPAN><SPAN>()&nbsp;{ &nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;alert(</SPAN><SPAN class=string>'you&nbsp;hurt&nbsp;me!'</SPAN><SPAN>);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>});&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">$('#button').click(function() {
    alert('you hurt me!');
});
</PRE>
<P>&nbsp;</P>
<P>也可以这样写：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>$(</SPAN><SPAN class=string>'#button'</SPAN><SPAN>).bind(</SPAN><SPAN
		class=string>'click'</SPAN><SPAN>,&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>()&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;alert(</SPAN><SPAN class=string>"don't&nbsp;touch&nbsp;me!"</SPAN><SPAN>);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>});&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">$('#button').bind('click', function() {
    alert("don't touch me!");
});</PRE>
<P>&nbsp;</P>
<P>想到click的实现应该基于bind, 搜索一下bind, 来到这里：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>jQuery.each([</SPAN><SPAN class=string>"bind"</SPAN><SPAN>,&nbsp;</SPAN><SPAN
		class=string>"one"</SPAN><SPAN>],&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>(&nbsp;i,&nbsp;name&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;jQuery.fn[&nbsp;name&nbsp;]&nbsp;=&nbsp;</SPAN><SPAN
		class=keyword>function</SPAN><SPAN>(&nbsp;type,&nbsp;data,&nbsp;fn&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=comment>//&nbsp;Handle&nbsp;object&nbsp;literals</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">jQuery.each(["bind", "one"], function( i, name ) {
	jQuery.fn[ name ] = function( type, data, fn ) {
		// Handle object literals</PRE>
<P>&nbsp;</P>
<P>看来bind 和 one 有点关系呀！它们的签名都是这样：<BR>
<BR>
<STRONG>function(type, data, fn);</STRONG></P>
<P>&nbsp;</P>
<P>one&nbsp;是啥？</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>$(</SPAN><SPAN class=string>'#button'</SPAN><SPAN>).one(</SPAN><SPAN
		class=string>'click'</SPAN><SPAN>,&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>()&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;alert(</SPAN><SPAN class=string>'下次点我就不会有效果了!'</SPAN><SPAN>);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>});&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">$('#button').one('click', function() {
    alert('下次点我就不会有效果了!');
});</PRE>
<P>&nbsp;</P>
<P>没问题，我们go on</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;</SPAN><SPAN class=keyword>typeof</SPAN><SPAN>&nbsp;type&nbsp;===&nbsp;</SPAN><SPAN
		class=string>"object"</SPAN><SPAN>&nbsp;)&nbsp;{ &nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>for</SPAN><SPAN>&nbsp;(&nbsp;</SPAN><SPAN
		class=keyword>var</SPAN><SPAN>&nbsp;key&nbsp;</SPAN><SPAN class=keyword>in</SPAN><SPAN>&nbsp;type&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>this</SPAN><SPAN>[&nbsp;name&nbsp;](key,&nbsp;data,&nbsp;type[key],&nbsp;fn);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>return</SPAN><SPAN>&nbsp;</SPAN><SPAN
		class=keyword>this</SPAN><SPAN>; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>}&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		if ( typeof type === "object" ) {
			for ( var key in type ) {
				this[ name ](key, data, type[key], fn);
			}
			return this;
		}</PRE>
<P>&nbsp;</P>
<P><STRONG>在1.4中，我们可以一次绑定多个事件</STRONG>：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>$(</SPAN><SPAN class=string>'#div'</SPAN><SPAN>).bind({
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;click:&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>()&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;}, &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;mouseenter:&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>()&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;}&nbsp; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>});&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">$('#div').bind({
  click: function() {
  },
  mouseenter: function() {
  } 
});</PRE>
<P>&nbsp;</P>
<P>接着往下看：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;jQuery.isFunction(&nbsp;data&nbsp;)&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;thisObject&nbsp;=&nbsp;fn;&nbsp;&nbsp;</SPAN><SPAN
		class=comment>//&nbsp;thisObject&nbsp;哪里来的？ </SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;fn&nbsp;=&nbsp;data; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;undefined; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>}&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		if ( jQuery.isFunction( data ) ) {
			thisObject = fn;  // thisObject 哪里来的？
			fn = data;
			data = undefined;
		}</PRE>
<P>&nbsp;</P>
<P>bind 和 one 的 签名是 function(type, [data], fn),&nbsp; 这个 if 让我们可以省略 data。<BR>
此外 thisObject = fn;&nbsp; thisObject 哪里来的？&nbsp;</P>
<P>&nbsp;</P>
<P>我的感觉是作者可能想让 bind 中的事件能够绑定特定的scope。</P>
<P>如： <STRONG>（注，这段功能我是假想）</STRONG></P>
<P>$('#button').bind('click', function() {<BR>
&nbsp;&nbsp;&nbsp; this.name;&nbsp; // 现在的this不是 button<BR>
}, { name: 123&nbsp;});</P>
<P><BR>
但现在并没有实现，而且也不需要实现，因为有jQuery.proxy 帮助我们完成需要的事。<BR>
&nbsp;如果实现，函数签名应该是：&nbsp; function( type, data, fn, thisObject);</P>
<P>-----------</P>
<P>&nbsp;</P>
<P>继续：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;handler&nbsp;=&nbsp;name&nbsp;===&nbsp;</SPAN><SPAN
		class=string>"one"</SPAN><SPAN>&nbsp;?&nbsp;jQuery.proxy(&nbsp;fn,&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>(&nbsp;event&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jQuery(&nbsp;</SPAN><SPAN
		class=keyword>this</SPAN><SPAN>&nbsp;).unbind(&nbsp;event,&nbsp;handler&nbsp;);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN
		class=keyword>return</SPAN><SPAN>&nbsp;fn.apply(&nbsp;</SPAN><SPAN class=keyword>this</SPAN><SPAN>,&nbsp;arguments&nbsp;);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})&nbsp;:&nbsp;fn;&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">var handler = name === "one" ? jQuery.proxy( fn, function( event ) {
			jQuery( this ).unbind( event, handler );
			return fn.apply( this, arguments );
		}) : fn;</PRE>
<P>&nbsp;</P>
<P>这段代码对one进行特别处理， 创建一个新的代理事件方法，让其执行后进行解绑，以达到one的效果。</P>
<P>&nbsp;</P>
<P>jQuery.proxy 是 1.4 中新添加的方法, 它可以生成一个代理function, 用于改变fn的scope。</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>proxy:&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>(&nbsp;fn,&nbsp;proxy,&nbsp;thisObject&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;arguments.length&nbsp;===&nbsp;2&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;</SPAN><SPAN
		class=keyword>typeof</SPAN><SPAN>&nbsp;proxy&nbsp;===&nbsp;</SPAN><SPAN class=string>"string"</SPAN><SPAN>&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thisObject&nbsp;=&nbsp;fn;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn&nbsp;=&nbsp;thisObject[&nbsp;proxy&nbsp;];
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy&nbsp;=&nbsp;undefined;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</SPAN><SPAN class=keyword>else</SPAN><SPAN>&nbsp;</SPAN><SPAN
		class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;proxy&nbsp;&amp;&amp;&nbsp;!jQuery.isFunction(&nbsp;proxy&nbsp;)&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thisObject&nbsp;=&nbsp;proxy;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy&nbsp;=&nbsp;undefined;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;!proxy&nbsp;&amp;&amp;&nbsp;fn&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy&nbsp;=&nbsp;</SPAN><SPAN
		class=keyword>function</SPAN><SPAN>()&nbsp;{ &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN
		class=keyword>return</SPAN><SPAN>&nbsp;fn.apply(&nbsp;thisObject&nbsp;||&nbsp;</SPAN><SPAN
		class=keyword>this</SPAN><SPAN>,&nbsp;arguments&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;fn&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy.guid&nbsp;=&nbsp;fn.guid&nbsp;=&nbsp;fn.guid&nbsp;||&nbsp;proxy.guid&nbsp;||&nbsp;jQuery.guid++;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>return</SPAN><SPAN>&nbsp;proxy;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>},&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">	proxy: function( fn, proxy, thisObject ) {
		if ( arguments.length === 2 ) {
			if ( typeof proxy === "string" ) {
				thisObject = fn;
				fn = thisObject[ proxy ];
				proxy = undefined;
			} else if ( proxy &amp;&amp; !jQuery.isFunction( proxy ) ) {
				thisObject = proxy;
				proxy = undefined;
			}
		}

		if ( !proxy &amp;&amp; fn ) {
			proxy = function() {
				return fn.apply( thisObject || this, arguments );
			};
		}

		if ( fn ) {
			proxy.guid = fn.guid = fn.guid || proxy.guid || jQuery.guid++;
		}
		return proxy;
	},</PRE>
<P>&nbsp;</P>
<P>公开的API使用两个参数的版本：</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;user&nbsp;=&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;</SPAN><SPAN class=string>"bena"</SPAN><SPAN>,
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;say:&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>()&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alert(&nbsp;</SPAN><SPAN
		class=keyword>this</SPAN><SPAN>.name&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>}; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>$(</SPAN><SPAN class=string>"#button"</SPAN><SPAN>).click(jQuery.proxy(user,&nbsp;</SPAN><SPAN
		class=string>'say'</SPAN><SPAN>)); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>$(</SPAN><SPAN class=string>"#button"</SPAN><SPAN>).click(jQuery.proxy(user.say,&nbsp;user));&nbsp;&nbsp;&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">var user = {
	name: "bena",
	say: function() {
		alert( this.name );
	 }
};

$("#button").click(jQuery.proxy(user, 'say'));

$("#button").click(jQuery.proxy(user.say, user)); &nbsp;</PRE>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>但在这里没有"正规使用"， 仅仅为它们设置了一个guid。</P>
<P>&nbsp;</P>
<P>写得白一点就是：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;handler&nbsp;&nbsp;=&nbsp;fn;
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(name&nbsp;===&nbsp;</SPAN><SPAN
		class=string>'one'</SPAN><SPAN>)&nbsp;{ &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handler&nbsp;=&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>(event)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jQuery(</SPAN><SPAN class=keyword>this</SPAN><SPAN>).unbind(event,&nbsp;handler);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>return</SPAN><SPAN>&nbsp;fn.apply(</SPAN><SPAN
		class=keyword>this</SPAN><SPAN>,&nbsp;arguments); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;}; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handler.guid&nbsp;=&nbsp;fn.guid&nbsp;=&nbsp;...;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>}&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">var handler  = fn;
if (name === 'one') {
	handler = function(event) {
		jQuery(this).unbind(event, handler);
		return fn.apply(this, arguments);
	};
	handler.guid = fn.guid = ...;
}</PRE>
<P>&nbsp;</P>
<P>完成了这个之后，接着就要把任务交给 jQuery.event.add 啦</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>return</SPAN><SPAN>&nbsp;type&nbsp;===&nbsp;</SPAN><SPAN
		class=string>"unload"</SPAN><SPAN>&nbsp;&amp;&amp;&nbsp;name&nbsp;!==&nbsp;</SPAN><SPAN
		class=string>"one"</SPAN><SPAN>&nbsp;? &nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>this</SPAN><SPAN>.one(&nbsp;type,&nbsp;data,&nbsp;fn,&nbsp;thisObject&nbsp;)&nbsp;:
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>this</SPAN><SPAN>.each(</SPAN><SPAN
		class=keyword>function</SPAN><SPAN>()&nbsp;{ &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jQuery.event.add(&nbsp;</SPAN><SPAN
		class=keyword>this</SPAN><SPAN>,&nbsp;type,&nbsp;handler,&nbsp;data&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;});&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		return type === "unload" &amp;&amp; name !== "one" ?
			this.one( type, data, fn, thisObject ) :
			this.each(function() {
				jQuery.event.add( this, type, handler, data );
			});</PRE>
<P><BR>
当 type == 'unload'&nbsp;时： this.one(type, data, fn, thisObject);&nbsp; //
看，这里是调用四个参数的，和我们上面的猜想一致(可能在下一版本中实现)</P>
<P>&nbsp;</P>
<P>下面我们就要来看看重要的：</P>
<P>&nbsp;</P>
<P><STRONG>jQuery.event.add(elem, type, handler, data);</STRONG>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>jQuery.event&nbsp;=&nbsp;{ &nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;add:&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>(&nbsp;elem,&nbsp;types,&nbsp;handler,&nbsp;data&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;elem.nodeType&nbsp;===&nbsp;3&nbsp;||&nbsp;elem.nodeType&nbsp;===&nbsp;8&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN
		class=keyword>return</SPAN><SPAN>; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=comment>//&nbsp;For&nbsp;whatever&nbsp;reason,&nbsp;IE&nbsp;has&nbsp;trouble&nbsp;passing&nbsp;the&nbsp;window&nbsp;object
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=comment>//&nbsp;around,&nbsp;causing&nbsp;it&nbsp;to&nbsp;be&nbsp;cloned&nbsp;in&nbsp;the&nbsp;process
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;elem.setInterval&nbsp;&amp;&amp;&nbsp;(&nbsp;elem&nbsp;!==&nbsp;window&nbsp;&amp;&amp;&nbsp;!elem.frameElement&nbsp;)&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elem&nbsp;=&nbsp;window;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;!handler.guid&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.guid&nbsp;=&nbsp;jQuery.guid++;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">jQuery.event = {
	add: function( elem, types, handler, data ) {
		if ( elem.nodeType === 3 || elem.nodeType === 8 ) {
			return;
		}

		// For whatever reason, IE has trouble passing the window object
		// around, causing it to be cloned in the process
		if ( elem.setInterval &amp;&amp; ( elem !== window &amp;&amp; !elem.frameElement ) ) {
			elem = window;
		}

		if ( !handler.guid ) {
			handler.guid = jQuery.guid++;
		}</PRE>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>nodeType == 3 表示文本text， nodeType&nbsp; == 8 表示注释， 这两个不需要事件， 所以略过。</P>
<P>&nbsp;</P>
<P>如果是window 对象， 对IE进行特别的处理（IE真是怪呀）</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>接着往下看：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;data&nbsp;!==&nbsp;undefined&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=comment>//&nbsp;Create&nbsp;temporary&nbsp;function&nbsp;pointer&nbsp;to&nbsp;original&nbsp;handler
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;fn&nbsp;=&nbsp;handler;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=comment>//&nbsp;Create&nbsp;unique&nbsp;handler&nbsp;function,&nbsp;wrapped&nbsp;around&nbsp;original&nbsp;handler
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handler&nbsp;=&nbsp;jQuery.proxy(&nbsp;fn&nbsp;);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=comment>//&nbsp;Store&nbsp;data&nbsp;in&nbsp;unique&nbsp;handler
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handler.data&nbsp;=&nbsp;data; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>}&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		if ( data !== undefined ) {
			// Create temporary function pointer to original handler
			var fn = handler;

			// Create unique handler function, wrapped around original handler
			handler = jQuery.proxy( fn );

			// Store data in unique handler
			handler.data = data;
		}</PRE>
<P>&nbsp;</P>
<P>如果有data, 会创建一个原事件方法的代理，然后设置data。因为我们可能会挂接一个handler到多个事件</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>继续：</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;events&nbsp;=&nbsp;jQuery.data(&nbsp;elem,&nbsp;</SPAN><SPAN
		class=string>"events"</SPAN><SPAN>&nbsp;)&nbsp;||&nbsp;jQuery.data(&nbsp;elem,&nbsp;</SPAN><SPAN
		class=string>"events"</SPAN><SPAN>,&nbsp;{}&nbsp;), &nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handle&nbsp;=&nbsp;jQuery.data(&nbsp;elem,&nbsp;</SPAN><SPAN
		class=string>"handle"</SPAN><SPAN>&nbsp;),&nbsp;eventHandle; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;!handle&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;eventHandle&nbsp;=&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>()&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>return</SPAN><SPAN>&nbsp;</SPAN><SPAN
		class=keyword>typeof</SPAN><SPAN>&nbsp;jQuery&nbsp;!==&nbsp;</SPAN><SPAN class=string>"undefined"</SPAN><SPAN>&nbsp;&amp;&amp;&nbsp;!jQuery.event.triggered&nbsp;?
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jQuery.event.handle.apply(&nbsp;eventHandle.elem,&nbsp;arguments&nbsp;)&nbsp;:
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undefined;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;}; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handle&nbsp;=&nbsp;jQuery.data(&nbsp;elem,&nbsp;</SPAN><SPAN
		class=string>"handle"</SPAN><SPAN>,&nbsp;eventHandle&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;!handle&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>return</SPAN><SPAN>;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=comment>//&nbsp;Add&nbsp;elem&nbsp;as&nbsp;a&nbsp;property&nbsp;of&nbsp;the&nbsp;handle&nbsp;function
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=comment>//&nbsp;This&nbsp;is&nbsp;to&nbsp;prevent&nbsp;a&nbsp;memory&nbsp;leak&nbsp;with&nbsp;non-native
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=comment>//&nbsp;event&nbsp;in&nbsp;IE. </SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>handle.elem&nbsp;=&nbsp;elem;&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		var events = jQuery.data( elem, "events" ) || jQuery.data( elem, "events", {} ),
			handle = jQuery.data( elem, "handle" ), eventHandle;

		if ( !handle ) {
			eventHandle = function() {
				return typeof jQuery !== "undefined" &amp;&amp; !jQuery.event.triggered ?
					jQuery.event.handle.apply( eventHandle.elem, arguments ) :
					undefined;
			};

			handle = jQuery.data( elem, "handle", eventHandle );
		}

		if ( !handle ) {
			return;
		}

		// Add elem as a property of the handle function
		// This is to prevent a memory leak with non-native
		// event in IE.
		handle.elem = elem;</PRE>
<P>&nbsp;</P>
<P>这一段创建（获取）节点相关联的两个对象: events 和 handle (节点上有多个事件，则公用)</P>
<P>&nbsp;</P>
<P>events 是一个普通对象。<BR>
handle 是一个函数， 函数体等用到的时候再看。<BR>
<BR>
因为不是任何节点都能 jQuery.data,像(embed, object, applet)&nbsp;所以上面有一个 if (!handle) 判断。</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>types&nbsp;=&nbsp;types.split(&nbsp;/\s+/&nbsp;); &nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;type,&nbsp;i=0; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>while</SPAN><SPAN>&nbsp;(&nbsp;(type&nbsp;=&nbsp;types[&nbsp;i++&nbsp;])&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=comment>//&nbsp;Namespaced&nbsp;event&nbsp;handlers
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;namespaces&nbsp;=&nbsp;type.split(</SPAN><SPAN
		class=string>"."</SPAN><SPAN>); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;=&nbsp;namespaces.shift(); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handler.type&nbsp;=&nbsp;namespaces.slice(0).sort().join(</SPAN><SPAN
		class=string>"."</SPAN><SPAN>);&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		types = types.split( /\s+/ );
		var type, i=0;
		while ( (type = types[ i++ ]) ) {
			// Namespaced event handlers
			var namespaces = type.split(".");
			type = namespaces.shift();
			handler.type = namespaces.slice(0).sort().join(".");</PRE>
<P>&nbsp;</P>
<P>我们可以这样使用：</P>
<P>&nbsp;</P>
<P>$('#button').bind('click mouseenter', function() {}); // 同时绑定多个事件。</P>
<P>&nbsp;</P>
<P>自1.3以后，jQuery也支持namespace event。</P>
<P>&nbsp;</P>
<P>可以这样调用：</P>
<P>&nbsp;</P>
<P>$('#button').bind('click.abc.def', function() {});</P>
<P>&nbsp;</P>
<P>此时 type = 'click',&nbsp; handler.type = 'abc.def'</P>
<P>&nbsp;</P>
<P>再往下看：</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;handlers&nbsp;=&nbsp;events[&nbsp;type&nbsp;],
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;special&nbsp;=&nbsp;</SPAN><SPAN class=keyword>this</SPAN><SPAN>.special[&nbsp;type&nbsp;]&nbsp;||&nbsp;{};
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;!handlers&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handlers&nbsp;=&nbsp;events[&nbsp;type&nbsp;]&nbsp;=&nbsp;{};
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;!special.setup&nbsp;||&nbsp;special.setup.call(&nbsp;elem,&nbsp;data,&nbsp;namespaces,&nbsp;handler)&nbsp;===&nbsp;</SPAN><SPAN
		class=keyword>false</SPAN><SPAN>&nbsp;)&nbsp;{ &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;elem.addEventListener&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elem.addEventListener(&nbsp;type,&nbsp;handle,&nbsp;</SPAN><SPAN
		class=keyword>false</SPAN><SPAN>&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</SPAN><SPAN class=keyword>else</SPAN><SPAN>&nbsp;</SPAN><SPAN
		class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;elem.attachEvent&nbsp;)&nbsp;{ &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elem.attachEvent(&nbsp;</SPAN><SPAN
		class=string>"on"</SPAN><SPAN>&nbsp;+&nbsp;type,&nbsp;handle&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>}&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">			var handlers = events[ type ],
				special = this.special[ type ] || {};

			if ( !handlers ) {
				handlers = events[ type ] = {};

				if ( !special.setup || special.setup.call( elem, data, namespaces, handler) === false ) {
					if ( elem.addEventListener ) {
						elem.addEventListener( type, handle, false );
					} else if ( elem.attachEvent ) {
						elem.attachEvent( "on" + type, handle );
					}
				}
			}</PRE>
<P>&nbsp;</P>
<P>先不管 handlers = events[type] 是啥， 反正一开始肯定是空的：）</P>
<P>我们的type也不special。</P>
<P>&nbsp;</P>
<P>代码终于到了这里：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;elem.addEventListener&nbsp;)&nbsp;{&nbsp;</SPAN><SPAN
		class=comment>//&nbsp;DOM </SPAN><SPAN>&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;elem.addEventListener(&nbsp;type,&nbsp;handle,&nbsp;</SPAN><SPAN
		class=keyword>false</SPAN><SPAN>&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>}&nbsp;</SPAN><SPAN class=keyword>else</SPAN><SPAN>&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;elem.attachEvent&nbsp;)&nbsp;{&nbsp;</SPAN><SPAN
		class=comment>//&nbsp;IE </SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;elem.attachEvent(&nbsp;</SPAN><SPAN class=string>"on"</SPAN><SPAN>&nbsp;+&nbsp;type,&nbsp;handle&nbsp;);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>}&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">if ( elem.addEventListener ) { // DOM
	elem.addEventListener( type, handle, false );
} else if ( elem.attachEvent ) { // IE
	elem.attachEvent( "on" + type, handle );
}</PRE>
<P>&nbsp;</P>
<P>我们看到， 事件终于在这里挂接，并且一个节点相同type的事件只挂接一次。</P>
<P>&nbsp;</P>
<P>而事件触发时，将会调用 handle （就是这个上面被我们暂时忽略的方法，现在要仔细看）：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;!handle&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;eventHandle&nbsp;=&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>()&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>return</SPAN><SPAN>&nbsp;</SPAN><SPAN
		class=keyword>typeof</SPAN><SPAN>&nbsp;jQuery&nbsp;!==&nbsp;</SPAN><SPAN class=string>"undefined"</SPAN><SPAN>&nbsp;&amp;&amp;&nbsp;!jQuery.event.triggered&nbsp;?
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jQuery.event.handle.apply(&nbsp;eventHandle.elem,&nbsp;arguments&nbsp;)&nbsp;:
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undefined;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;}; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;handle&nbsp;=&nbsp;jQuery.data(&nbsp;elem,&nbsp;</SPAN><SPAN
		class=string>"handle"</SPAN><SPAN>,&nbsp;eventHandle&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;!handle&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>return</SPAN><SPAN>;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=comment>//&nbsp;Add&nbsp;elem&nbsp;as&nbsp;a&nbsp;property&nbsp;of&nbsp;the&nbsp;handle&nbsp;function
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=comment>//&nbsp;This&nbsp;is&nbsp;to&nbsp;prevent&nbsp;a&nbsp;memory&nbsp;leak&nbsp;with&nbsp;non-native
	</SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=comment>//&nbsp;event&nbsp;in&nbsp;IE. </SPAN><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>handle.elem&nbsp;=&nbsp;elem;&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		if ( !handle ) {
			eventHandle = function() {
				return typeof jQuery !== "undefined" &amp;&amp; !jQuery.event.triggered ?
					jQuery.event.handle.apply( eventHandle.elem, arguments ) :
					undefined;
			};

			handle = jQuery.data( elem, "handle", eventHandle );
		}
		if ( !handle ) {
			return;
		}

		// Add elem as a property of the handle function
		// This is to prevent a memory leak with non-native
		// event in IE.
		handle.elem = elem;</PRE>
<P>&nbsp;</P>
<P>在页面unload后，jQuery 对象不存在了。jQuery.event.triggered 我们暂时也不用管。</P>
<P><BR>
handle 仅仅把操作代理给</P>
<P>handle = function() {<BR>
&nbsp;&nbsp;&nbsp; jQuery.event.handle.apply(elem, arguments) :<BR>
};</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P><STRONG>2. jQuery.event.handle(event)</STRONG></P>
<P>&nbsp;</P>
<P>这里的event是浏览器相关的， 此函数的scope（即this), 是 elem。</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN>handle:&nbsp;</SPAN><SPAN class=keyword>function</SPAN><SPAN>(&nbsp;event&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;all,&nbsp;handlers;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;event&nbsp;=&nbsp;arguments[0]&nbsp;=&nbsp;jQuery.event.fix(&nbsp;event&nbsp;||&nbsp;window.event&nbsp;);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;event.currentTarget&nbsp;=&nbsp;</SPAN><SPAN class=keyword>this</SPAN><SPAN>;&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">	handle: function( event ) {
		var all, handlers;

		event = arguments[0] = jQuery.event.fix( event || window.event );
		event.currentTarget = this;</PRE>
<P>&nbsp;</P>
<P>首先将 event 包装成 jQuery.Event 对象，&nbsp;让其在所有浏览器上都有相同的属性和行为。</P>
<P>&nbsp;</P>
<P>然后根据 type从节点找到 handlers，准备执行：</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;namespaces&nbsp;=&nbsp;event.type.split(</SPAN><SPAN
		class=string>"."</SPAN><SPAN>); &nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>event.type&nbsp;=&nbsp;namespaces.shift(); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>all&nbsp;=&nbsp;!namespaces.length&nbsp;&amp;&amp;&nbsp;!event.exclusive;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;namespace&nbsp;=&nbsp;</SPAN><SPAN
		class=keyword>new</SPAN><SPAN>&nbsp;RegExp(</SPAN><SPAN class=string>"(^|\\.)"</SPAN><SPAN>&nbsp;+&nbsp;namespaces.slice(0).sort().join(</SPAN><SPAN
		class=string>"\\.(?:.*\\.)?"</SPAN><SPAN>)&nbsp;+&nbsp;</SPAN><SPAN class=string>"(\\.|$)"</SPAN><SPAN>);
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>handlers&nbsp;=&nbsp;(&nbsp;jQuery.data(</SPAN><SPAN class=keyword>this</SPAN><SPAN>,&nbsp;</SPAN><SPAN
		class=string>"events"</SPAN><SPAN>)&nbsp;||&nbsp;{}&nbsp;)[&nbsp;event.type&nbsp;];&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		var namespaces = event.type.split(".");
		event.type = namespaces.shift();

		all = !namespaces.length &amp;&amp; !event.exclusive;

		var namespace = new RegExp("(^|\\.)" + namespaces.slice(0).sort().join("\\.(?:.*\\.)?") + "(\\.|$)");

		handlers = ( jQuery.data(this, "events") || {} )[ event.type ];</PRE>
<P>&nbsp;</P>
<P>由浏览器触发的事件 type 不会包含namespace。</P>
<P>用户调用trigger时，可以包含namespace,&nbsp; 到时候再来看。&nbsp;</P>
<P>&nbsp;</P>
<P>下面就是执行handers了:</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<DIV class=dp-highlighter>
<DIV class=bar>
<DIV class=tools>Js代码</DIV>
</DIV>
<OL class=dp-c>
	<LI><SPAN><SPAN class=keyword>for</SPAN><SPAN>&nbsp;(&nbsp;</SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;j&nbsp;</SPAN><SPAN
		class=keyword>in</SPAN><SPAN>&nbsp;handlers&nbsp;)&nbsp;{ &nbsp;&nbsp;</SPAN></SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;handler&nbsp;=&nbsp;handlers[&nbsp;j&nbsp;];
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;all&nbsp;||&nbsp;namespace.test(handler.type)&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.handler&nbsp;=&nbsp;handler;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.data&nbsp;=&nbsp;handler.data;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>var</SPAN><SPAN>&nbsp;ret&nbsp;=&nbsp;handler.apply(&nbsp;</SPAN><SPAN
		class=keyword>this</SPAN><SPAN>,&nbsp;arguments&nbsp;); &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;ret&nbsp;!==&nbsp;undefined&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.result&nbsp;=&nbsp;ret;
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN
		class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;ret&nbsp;===&nbsp;</SPAN><SPAN class=keyword>false</SPAN><SPAN>&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.preventDefault();
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.stopPropagation();
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN class=keyword>if</SPAN><SPAN>&nbsp;(&nbsp;event.isImmediatePropagationStopped()&nbsp;)&nbsp;{
	&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN
		class=keyword>break</SPAN><SPAN>; &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>} &nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN>&nbsp;&nbsp;</SPAN></LI>
	<LI><SPAN></SPAN><SPAN class=keyword>return</SPAN><SPAN>&nbsp;event.result;&nbsp;&nbsp;</SPAN></LI>
</OL>
</DIV>
<PRE style="DISPLAY: none" class=js name="code">		for ( var j in handlers ) {
			var handler = handlers[ j ];
			if ( all || namespace.test(handler.type) ) {
				event.handler = handler;
				event.data = handler.data;

				var ret = handler.apply( this, arguments );

				if ( ret !== undefined ) {
					event.result = ret;
					if ( ret === false ) {
						event.preventDefault();
						event.stopPropagation();
					}
				}

				if ( event.isImmediatePropagationStopped() ) {
					break;
				}

			}
		}

		return event.result;</PRE>
<P>&nbsp;</P>
<P>&nbsp;可以看到</P>
<P>event.data = handler.data。</P>
<P>&nbsp;</P>
<P>事件方法返回 false 相当于：</P>
<P>event.preventDefault();<BR>
event.stopPropagation();</P>
<P>&nbsp;</P>
<P>//-------------------</P>
</DIV>
</DIV>

</body>
</html>